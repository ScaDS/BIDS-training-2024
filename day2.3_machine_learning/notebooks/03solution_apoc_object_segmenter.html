

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Object segmentation and classifiation on OpenCL-compatible GPUs &#8212; Bio-image Data Science Training School @ ScaDS.AI, May 2024</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'day2.3_machine_learning/notebooks/03solution_apoc_object_segmenter';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Bio-Image Data Science Training Schools 2024
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Course Preparation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../day0_preparation/readme.html">Setting up your computer</a></li>

</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Monday</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../day1.1_python_basics/readme.html">Python basics</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/01_jupyter_notebooks.html">Python code and Jupyter notebooks</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/02_basic_terms_and_types.html">Basics terms and types for Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/03_notebook_pitfalls.html">Pitfalls when working with Jupyter notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/04_math_in_python.html">Basic math in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/05_sequence_types.html">Sequences in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/05a_indexing_sequences.html">Indexing and slicing of sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/05b_masking_arrays.html">Masking NumPy arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/06_dictionaries_and_tables.html">Dictionaries</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/07_conditions.html">Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/08_loops.html">Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.1_python_basics/09_custom_functions.html">Custom Functions</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../day1.2_file_handling/readme.html">File handling and working with images</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../day1.2_file_handling/01_list_files_in_a_folder.html">How process files in a folder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.2_file_handling/02_interactive_image_visualization.html">Image visualization with stackview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.2_file_handling/03_opening_images_using_aicsimageio.html">Reading files with AICSImageIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.2_file_handling/04_nextcloud.html">Optional: Accessing image files in the nextcloud</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.2_file_handling/05_bia_bob.html">Optional: Coding assistance</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../day1.3_image_processing_basics/readme.html">Image processing basics</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../day1.3_image_processing_basics/00_images_as_arrays.html">Images are arrays of numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.3_image_processing_basics/01_opening_visualizing_images.html">Opening and visualizing images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.3_image_processing_basics/02_Brightness_and_Contrast.html">Brightness and Contrast</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../day1.3_image_processing_basics/03_Cropping_images.html">Cropping images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.3_image_processing_basics/04_Image_Filters.html">Image Processing Filters</a></li>


<li class="toctree-l2"><a class="reference internal" href="../../day1.3_image_processing_basics/05_Binarization.html">Image Binarization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day1.3_image_processing_basics/06_Morphological_operations.html">Morphological Image Processing</a></li>


<li class="toctree-l2"><a class="reference internal" href="../../day1.3_image_processing_basics/bonus_simulated_dataset_remove_noise_and_background.html">Simulation of image formation + image restoration</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tuesday</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../day2.1_image_segmentation/readme.html">Image segmentation</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../day2.1_image_segmentation/10_napari-assistant.html">Interactive bioimage analysis workflow design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.1_image_segmentation/11_notebook_export.html">Generating Jupyter Notebooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.1_image_segmentation/12_voronoi_otsu_labeling.html">Voronoi-Otsu-labeling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.1_image_segmentation/13_watershed.html">The [seeded] watershed algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.1_image_segmentation/22_napari_intro.html">Scripting Napari using Python</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../day2.1_image_segmentation/30_Segmentation_3D.html">3D Image Segmentation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../day2.2_feature_extraction/readme.html">Feature extraction</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../day2.2_feature_extraction/01_count_blobs.html">Counting bright objects in images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.2_feature_extraction/02_statistics_with_scikit_image.html">Statistics using Scikit-image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.2_feature_extraction/03_statistics_with_simpleitk.html">Statistics using SimpleITK</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.2_feature_extraction/04_roundness_circularity.html">Shape features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Machine Learning</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../day2.4_tabular_data_wrangling/readme.html">Tabular data wrangling</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../day2.4_tabular_data_wrangling/01_introduction_dataframes.html">Introduction to working with DataFrames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.4_tabular_data_wrangling/02_selecting_dataframes.html">Selecting data from DataFrames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.4_tabular_data_wrangling/03_appending_dataframes.html">Appending and extending DataFrames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.4_tabular_data_wrangling/04_handle_missing_data.html">Handling missing data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.4_tabular_data_wrangling/05_group_by.html">Group by: split-apply-combine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day2.4_tabular_data_wrangling/06_tidy_data.html">Tidy-Data</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Wednesday</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../day3.1_explorative_data_science/readme.html">Explorative data science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../day3.2_data_visualization/readme.html">Data Visualization</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../day3.3a_basic_plotting/readme.html">Plotting Basics</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../day3.3a_basic_plotting/01_Introduction_to_Seaborn.html">Introduction to Seaborn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day3.3a_basic_plotting/02_Plotting_distributions.html">Plotting Distributions with Seaborn</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../day3.3b_advanced_plotting/readme.html">Advanced Plotting</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../day3.3b_advanced_plotting/00_getdata.html">Part 0: Get data set for plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day3.3b_advanced_plotting/01_seabornobj_solution.html">Part 1: Time series and other simple plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../day3.3b_advanced_plotting/02_dataviz_MLunsupervised_solution.html">Part 2 Data exploration by unsupervised learning</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../day3.3b_advanced_plotting/03_dataviz_MLsupervised_solution.html">Part 3: Machine Learning insights by Data Viz</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Information</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../imprint.html">Imprint</a></li>

</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/scads/BIDS-training-2024" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/scads/BIDS-training-2024/issues/new?title=Issue%20on%20page%20%2Fday2.3_machine_learning/notebooks/03solution_apoc_object_segmenter.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/day2.3_machine_learning/notebooks/03solution_apoc_object_segmenter.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Object segmentation and classifiation on OpenCL-compatible GPUs</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-segmentation">Prediction / segmentation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-from-a-loaded-segmenter">Segmentation from a loaded segmenter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#object-classification">Object classification</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">Exercise</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="object-segmentation-and-classifiation-on-opencl-compatible-gpus">
<h1>Object segmentation and classifiation on OpenCL-compatible GPUs<a class="headerlink" href="#object-segmentation-and-classifiation-on-opencl-compatible-gpus" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://github.com/haesleinhuepf/apoc">APOC</a> is a Python library for pixel and object classification using machine learning based on <a class="reference external" href="https://github.com/clEsperanto/pyclesperanto_prototype">pyclesperanto</a> and <a class="reference external" href="https://scikit-learn.org/stable/">sklearn</a>. It accelerates Random Forest Classifiers to predict faster on graphics processing units supporting the <a class="reference external" href="https://www.khronos.org/opencl/">OpenCL</a> standard. For object segmentation, it uses a pixel classifier and connected components labeling.</p>
<p>If there are errors in the first two cells, containing messages such as “module not found: apoc”, “module not found: pyclesperanto_prototype” or “clGetPlatformIDs failed: PLATFORM_NOT_FOUND_KHR”</p>
<ul class="simple">
<li><p>Check <a class="reference external" href="https://github.com/haesleinhuepf/devbio-napari#installation">these installation instructions</a></p></li>
<li><p><a class="reference external" href="https://github.com/haesleinhuepf/devbio-napari#troubleshooting-graphics-cards-drivers">Install graphics card drivers</a> if neccessary</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imread</span><span class="p">,</span> <span class="n">imshow</span><span class="p">,</span> <span class="n">imsave</span>
<span class="kn">import</span> <span class="nn">pyclesperanto_prototype</span> <span class="k">as</span> <span class="nn">cle</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">apoc</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s start with loading an example image and some ground truth:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s1">&#39;data/blobs.tif&#39;</span><span class="p">)</span>
<span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/40f3a9b2cbf4ae2b8018c5e487701ae147e8533eaaf5fe09af90019ba5659332.png" src="../../_images/40f3a9b2cbf4ae2b8018c5e487701ae147e8533eaaf5fe09af90019ba5659332.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># you can use this to make manual annotations</span>
    <span class="kn">import</span> <span class="nn">napari</span>

    <span class="c1"># start napari</span>
    <span class="n">viewer</span> <span class="o">=</span> <span class="n">napari</span><span class="o">.</span><span class="n">Viewer</span><span class="p">()</span>
    <span class="n">napari</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># add image</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># add an empty labels layer and keep it in a variable</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">add_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s1">&#39;data/blobs_annotations.tif&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#imsave(&#39;annotations.tif&#39;, labels)</span>
<span class="n">manual_annotations</span> <span class="o">=</span> <span class="n">labels</span>

<span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">manual_annotations</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e4c672aa55c6103f4e2265b960ffd860ba32f31bdbe692e3fa636519b06580a4.png" src="../../_images/e4c672aa55c6103f4e2265b960ffd860ba32f31bdbe692e3fa636519b06580a4.png" />
</div>
</div>
<p>To see the image and the annotation on top, we overlay both:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">continue_drawing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">manual_annotations</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6f32039ce67a6ed0a9e213037bacab61940b8f360a6285bf24b6674f6a62fe0b.png" src="../../_images/6f32039ce67a6ed0a9e213037bacab61940b8f360a6285bf24b6674f6a62fe0b.png" />
</div>
</div>
<section id="training">
<h2>Training<a class="headerlink" href="#training" title="Permalink to this heading">#</a></h2>
<p>We now train a ObjectSegmenter, which is under the hood a <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">scikit-learn RandomForestClassifier</a>. After training, the classifier will be converted to <a class="reference external" href="https://github.com/clEsperanto/clij-opencl-kernels">clij-compatible OpenCL code</a> and save to disk under a given filename.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define features</span>
<span class="n">features</span> <span class="o">=</span> <span class="s2">&quot;gaussian_blur=1 gaussian_blur=5 sobel_of_gaussian_blur=1&quot;</span>

<span class="c1"># this is where the model will be saved</span>
<span class="n">cl_filename</span> <span class="o">=</span> <span class="s1">&#39;my_object_segmenter.cl&#39;</span>

<span class="c1"># delete classifier in case the file exists already</span>
<span class="n">apoc</span><span class="o">.</span><span class="n">erase_classifier</span><span class="p">(</span><span class="n">cl_filename</span><span class="p">)</span>

<span class="c1"># train classifier</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">apoc</span><span class="o">.</span><span class="n">ObjectSegmenter</span><span class="p">(</span><span class="n">opencl_filename</span><span class="o">=</span><span class="n">cl_filename</span><span class="p">,</span> <span class="n">positive_class_identifier</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">clf</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">manual_annotations</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="prediction-segmentation">
<h2>Prediction / segmentation<a class="headerlink" href="#prediction-segmentation" title="Permalink to this heading">#</a></h2>
<p>The classifier can then be used to classify all pixels in the given image. Starting point is again, the feature stack. Thus, the user must make sure that the same features are used for training and for prediction. Prediction can be done on the CPU using the original scikit-learn code and on the GPU using the generated OpenCL-code. OCLRFC works well if both result images look identical.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">segmentation_result</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
<span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">segmentation_result</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/20fc2f2ed7e927800f500bfdc9618e3df0f3a288df09dbc53a4126e634ae1161.png" src="../../_images/20fc2f2ed7e927800f500bfdc9618e3df0f3a288df09dbc53a4126e634ae1161.png" />
</div>
</div>
</section>
<section id="segmentation-from-a-loaded-segmenter">
<h2>Segmentation from a loaded segmenter<a class="headerlink" href="#segmentation-from-a-loaded-segmenter" title="Permalink to this heading">#</a></h2>
<p>After training, the segmenter has been stored as a file. This file can be loaded again and applied to other data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load segmenter from disk</span>
<span class="n">clf</span> <span class="o">=</span> <span class="n">apoc</span><span class="o">.</span><span class="n">ObjectSegmenter</span><span class="p">(</span><span class="n">opencl_filename</span><span class="o">=</span><span class="n">cl_filename</span><span class="p">)</span>

<span class="c1"># apply it</span>
<span class="n">segmentation_result</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
<span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">segmentation_result</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/20fc2f2ed7e927800f500bfdc9618e3df0f3a288df09dbc53a4126e634ae1161.png" src="../../_images/20fc2f2ed7e927800f500bfdc9618e3df0f3a288df09dbc53a4126e634ae1161.png" />
</div>
</div>
</section>
<section id="object-classification">
<h2>Object classification<a class="headerlink" href="#object-classification" title="Permalink to this heading">#</a></h2>
<p>When classifying segmented objects, we need to provide three images: The raw intensity image, a label image representing the objects and an annotation where different objects are marked with different labels. The first two are available above. We load the label annotation from disk. In this <code class="docutils literal notranslate"><span class="pre">annotation</span></code>, lines were drawn through three different kinds of objects:</p>
<ul class="simple">
<li><p>Small, round</p></li>
<li><p>Large, round</p></li>
<li><p>Large, elongated</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">annotation</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s1">&#39;data/blobs_label_annotation.tif&#39;</span><span class="p">)</span>

<span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">segmentation_result</span><span class="p">,</span> <span class="n">continue_drawing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/0b3efbb815d30816785a9e671ea5b67e440359de901f00e48848ba39160bd2d6.png" src="../../_images/0b3efbb815d30816785a9e671ea5b67e440359de901f00e48848ba39160bd2d6.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for the classification we define size and shape as criteria</span>
<span class="n">features</span> <span class="o">=</span> <span class="s1">&#39;area mean_max_distance_to_centroid_ratio&#39;</span>

<span class="c1"># This is where the model will be saved</span>
<span class="n">cl_filename_object_classifier</span> <span class="o">=</span> <span class="s2">&quot;my_object_classifier.cl&quot;</span>

<span class="c1"># delete classifier in case the file exists already</span>
<span class="n">apoc</span><span class="o">.</span><span class="n">erase_classifier</span><span class="p">(</span><span class="n">cl_filename_object_classifier</span><span class="p">)</span>

<span class="c1"># train the classifier</span>
<span class="n">classifier</span> <span class="o">=</span> <span class="n">apoc</span><span class="o">.</span><span class="n">ObjectClassifier</span><span class="p">(</span><span class="n">cl_filename_object_classifier</span><span class="p">)</span>
<span class="n">classifier</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">segmentation_result</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

<span class="c1"># determine object classification</span>
<span class="n">classification_result</span> <span class="o">=</span> <span class="n">classifier</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">segmentation_result</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
<span class="n">cle</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">classification_result</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/04e06a9edbf667323c50129a0aec28d6a6c1e71d8987e222eb12ed5f9459e4b5.png" src="../../_images/04e06a9edbf667323c50129a0aec28d6a6c1e71d8987e222eb12ed5f9459e4b5.png" />
</div>
</div>
</section>
<section id="exercise">
<h2>Exercise<a class="headerlink" href="#exercise" title="Permalink to this heading">#</a></h2>
<p>Use the graphical user interface of napari and change <code class="docutils literal notranslate"><span class="pre">blobs_label_annotation.tif</span></code> so that the classifier trained here differentiates two classes: Round and elongated objects.</p>
<p>Optional: <a class="reference external" href="https://github.com/haesleinhuepf/napari-accelerated-pixel-and-object-classification#object-classification">Use the graphical user interface of APOC</a>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./day2.3_machine_learning/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training">Training</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-segmentation">Prediction / segmentation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#segmentation-from-a-loaded-segmenter">Segmentation from a loaded segmenter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#object-classification">Object classification</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercise">Exercise</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Anja Neumann, Marie-Sophie von Braun, Matthias Täschner, Robert Haase
</p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    <p class="last-updated">
  Last updated on 2024-05-13.
  <br/>
</p>
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
Copyright: Licensed <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0</a> unless mentioned otherwise. 
Contributions and feedback are welcome.
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>